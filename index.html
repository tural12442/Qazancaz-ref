<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qazanc AZ</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
    body{background:#f5f5f5;color:#222}
    header{background:#222;color:#fff;padding:12px;text-align:center;font-size:18px}
    nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:flex;justify-content:space-around;padding:8px 0;border-top:1px solid #ddd}
    nav button{background:none;border:none;font-size:14px;color:#555}
    section{display:none;padding:20px}
    section.active{display:block}
    .card{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
    .balance{font-size:22px;font-weight:700;text-align:center}
    .copyBox{background:#efefef;padding:10px;border-radius:8px;text-align:center;cursor:pointer}
    .copyBox:active{background:#ddd}
    .toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 14px;border-radius:8px;opacity:0;transition:.3s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>💰 Qazanc AZ</header>

  <section id="home" class="active">
    <div class="card">
      <div class="balance">Balans: <span id="balance">0</span> AZN</div>
    </div>
    <div class="card">
      <button id="earnBtn" style="width:100%;padding:12px;font-size:16px;background:#222;color:#fff;border:none;border-radius:10px;">🎥 Reklam İzlə və Qazan</button>
    </div>
  </section>

  <section id="tasks">
    <div class="card">📋 Tapşırıqlar burda olacaq</div>
  </section>

  <section id="referral">
    <div class="card">
      <h3>👥 Referans Sistemi</h3>
      <p>Sənin referans linkin:</p>
      <div id="refLink" class="copyBox"></div>
      <small>Linkə toxunaraq kopyalaya bilərsən</small>
      <p style="margin-top:10px;">Dəvət etdiyin dost sayı: <b id="refCount">0</b></p>
    </div>
  </section>

  <section id="wallet">
    <div class="card">
      <h3>💼 Cüzdan</h3>
      <p>Ümumi balans: <span id="walletBal">0</span> AZN</p>
    </div>
  </section>

  <nav>
    <button onclick="show('home')">🏠 Ana səhifə</button>
    <button onclick="show('tasks')">✅ Tapşırıq</button>
    <button onclick="show('referral')">👥 Referans</button>
    <button onclick="show('wallet')">💼 Cüzdan</button>
  </nav>

  <div id="toast" class="toast">Kopyalandı!</div>

  <script>
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyD0dnb927FbT2LjZf06hxB6lBX2JaBdevc",
      authDomain: "qazanc-az-64da7.firebaseapp.com",
      projectId: "qazanc-az-64da7",
      storageBucket: "qazanc-az-64da7.firebasestorage.app",
      messagingSenderId: "1069574349445",
      appId: "1:1069574349445:web:b815928eca716f89617fec",
      measurementId: "G-Y5ZHFYLGMC"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Telegramdan UID al ---
    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get("uid") || "123456789";
    const refBy = urlParams.get("startapp") || "";

    // --- Sayfa geçişleri ---
    function show(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // --- Kullanıcı verisi yükle veya oluştur ---
    const userRef = db.collection("users").doc(uid);
    userRef.get().then(async (doc) => {
      if (!doc.exists) {
        await userRef.set({
          balance: 0,
          invited_by: refBy,
          referral_count: 0
        });
        // Referans varsa, davet edeni ödüllendir
        if (refBy) {
          const inviterRef = db.collection("users").doc(refBy);
          inviterRef.get().then(d => {
            if (d.exists) {
              const newCount = (d.data().referral_count || 0) + 1;
              const newBal = (d.data().balance || 0) + 0.1;
              inviterRef.update({ referral_count: newCount, balance: newBal });
            }
          });
        }
      }
      loadUser();
    });

    // --- Kullanıcıyı yükle ---
    function loadUser() {
      userRef.onSnapshot((doc) => {
        const data = doc.data();
        document.getElementById("balance").innerText = data.balance.toFixed(2);
        document.getElementById("walletBal").innerText = data.balance.toFixed(2);
        document.getElementById("refCount").innerText = data.referral_count;
        document.getElementById("refLink").innerText = `https://t.me/qazancazbot?startapp=${uid}`;
      });
    }

    // --- Link kopyalama ---
    document.getElementById("refLink").onclick = () => {
      const text = document.getElementById("refLink").innerText;
      navigator.clipboard.writeText(text);
      const toast = document.getElementById("toast");
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"),1500);
    };

    // --- Reklamdan kazanç ekle ---
    document.getElementById("earnBtn").onclick = async () => {
      const doc = await userRef.get();
      const bal = (doc.data().balance || 0) + 0.05;
      await userRef.update({ balance: bal });
    };
  </script>
</body>
</html>
